1. Build a Kong custom Docker image that includes oauth-proxy and update bundled environment variable
   Also add a custom resource definition for OAuth Proxy

2. Get rid of API gateway YAML from tokenhandler.docker for kubernetes.local
   Add custom resource definition to https://tokenhandler.mycluster.com/api

FIX 1: LUA PLUGINS
------------------
I need to set this also as an environment variable:

- KONG_PLUGINS: 'bundled,oauth-proxy'

Then run the OAuth Proxy LUA plugin in the ingress, and get rid of the gateway.

SUREN WORK
----------

    HELM VALUES
    -----------
    image:
      repository: curity/kong-custom
      tag: "2.8.1-alpine"

    proxy:
      enabled: true
      type: LoadBalancer

    ingressController:
      enabled: true
      installCRDs: false
      ingressClass: kong
      ingressClassAnnotations: {}
      rbac:
        create: true

    # Temporary workaround: disable HTTP2 on admin endpoint
    # https://github.com/Kong/kubernetes-ingress-controller/issues/2435
    admin:
      tls:
        parameters: []

    env:
      database: "off"
      LOG_LEVEL: "error"
      plugins: 'bundled,phantom-token' 

    DOCKERFILE
    ----------
    FROM kong:2.8.1-alpine

    # Fetch from luarocks, and set git options if required
    USER root
    RUN git config --global url."https://".insteadOf git:// && \
        git config --global advice.detachedHead false && \
        luarocks install kong-phantom-token

    USER kong

    CRD
    ---
    apiVersion: configuration.konghq.com/v1
    kind: KongPlugin
    metadata:
      name: phantom-token
    config:
      introspection_endpoint: http://curity-idsvr-runtime-svc.$idsvr_namespace.svc.cluster.local:8443/oauth/v2/oauth-introspect # k8s cluster internal URL
      client_id: api-gateway-client
      client_secret: Password123
      token_cache_seconds: 900
      scope: read
    plugin: phantom-token
